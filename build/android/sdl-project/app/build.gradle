plugins {
    id "com.android.application"
}

def trimToNull = { value ->
    if (value == null) {
        return null
    }
    def trimmed = value.trim()
    return trimmed.isEmpty() ? null : trimmed
}

def sdl2SourceDir = providers.gradleProperty("SDL2_SOURCE_DIR")
    .orElse(providers.environmentVariable("SDL2_SOURCE_DIR"))
    .orNull
sdl2SourceDir = trimToNull(sdl2SourceDir)

if (sdl2SourceDir == null) {
    throw new GradleException("Set SDL2_SOURCE_DIR to an SDL source tree with -PSDL2_SOURCE_DIR=/path/to/SDL.")
}

android {
    namespace "com.wildfiregames.zeroad"
    compileSdk 34

    buildFeatures {
        buildConfig true
    }

    defaultConfig {
        applicationId "com.wildfiregames.zeroad"
        minSdk 28
        targetSdk 34
        def versionNameEnv = System.getenv("VERSION_NAME")
        def versionCodeEnv = System.getenv("VERSION_CODE")
        versionName versionNameEnv != null && !versionNameEnv.trim().isEmpty() ? versionNameEnv : "0.0.1"
        versionCode versionCodeEnv != null && !versionCodeEnv.trim().isEmpty() ? Integer.parseInt(versionCodeEnv) : 1

        def dataManifestTemplateEnv = System.getenv("DATA_MANIFEST_URL_TEMPLATE")
        def dataManifestTemplate = dataManifestTemplateEnv != null ? dataManifestTemplateEnv : ""
        def dataManifestTemplateEscaped = dataManifestTemplate
                .replace("\\", "\\\\")
                .replace("\"", "\\\"")
        buildConfigField "String", "DATA_MANIFEST_URL_TEMPLATE", "\"${dataManifestTemplateEscaped}\""

        ndk {
            abiFilters "arm64-v8a"
        }

        externalNativeBuild {
            ndkBuild {
                arguments "SDL2_SOURCE_DIR=${sdl2SourceDir}"
            }
        }
    }

    def keystorePathEnv = trimToNull(System.getenv("ANDROID_KEYSTORE_PATH"))
    def keystorePasswordEnv = trimToNull(System.getenv("ANDROID_KEYSTORE_PASSWORD"))
    def keyAliasEnv = trimToNull(System.getenv("ANDROID_KEY_ALIAS"))
    def keyPasswordEnv = trimToNull(System.getenv("ANDROID_KEY_PASSWORD"))
    def hasReleaseSigning = keystorePathEnv != null && keystorePasswordEnv != null && keyAliasEnv != null && keyPasswordEnv != null

    if (hasReleaseSigning) {
        signingConfigs {
            release {
                storeFile file(keystorePathEnv)
                storePassword keystorePasswordEnv
                keyAlias keyAliasEnv
                keyPassword keyPasswordEnv
            }
        }
    }

    buildTypes {
        debug {
            debuggable true
        }
        release {
            minifyEnabled false
            if (hasReleaseSigning) {
                signingConfig signingConfigs.release
            }
        }
    }

    externalNativeBuild {
        ndkBuild {
            path file("src/main/jni/Android.mk")
        }
    }

    sourceSets {
        main {
            jniLibs.srcDirs = ["src/main/jniLibs"]
        }
    }
}
