name: Sync Upstream Tags

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GIT_LFS_SKIP_SMUDGE: "1"
      GIT_LFS_SKIP_PUSH: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch upstream tags
        run: |
          git remote add upstream https://gitea.wildfiregames.com/0ad/0ad || true
          git tag -l | sort > /tmp/tags_before.txt
          git fetch --tags upstream
          git tag -l | sort > /tmp/tags_after.txt
      - name: Disable LFS push checks
        run: |
          git config lfs.allowincompletepush true
          git lfs uninstall || true
      - name: Push tags to origin
        run: |
          git push origin --tags
      - name: Trigger release builds for new tags
        env:
          DISPATCH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}
        run: |
          NEW_TAGS="$(comm -13 /tmp/tags_before.txt /tmp/tags_after.txt | grep '^v' || true)"
          if [ -z "${NEW_TAGS}" ]; then
            echo "No new tags to build."
            exit 0
          fi
          if [ -z "${DISPATCH_TOKEN}" ]; then
            DISPATCH_TOKEN="${GITHUB_TOKEN}"
          fi
          if [ -z "${DISPATCH_TOKEN}" ]; then
            echo "No token available to dispatch workflows." >&2
            exit 1
          fi
          for tag in ${NEW_TAGS}; do
            echo "Dispatching Android Release APK for ${tag}"
            curl -sS -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${DISPATCH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/android-release.yml/dispatches" \
              -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"${tag}\"}}"
          done
